# Telegram AI-ассистент (напоминалка)

Исследовательский проект Telegram-бота, где бизнес-логика обработки пользовательских запросов вынесена в LLM-ассистента. Пользователь общается естественным языком, LLM формирует структурированные команды, а приложение валидирует и исполняет их.

## Текущий статус

- Локально работает.
- Тесты: `45 passed`.
- Текущее ограничение: лимиты OpenAI.
- VPS-деплой пока не выполнен.

## Ключевой функционал

- Создание напоминаний: одиночные, множественные, цикличные.
- Для напоминаний с датой начиная с завтра выполняются два уведомления: за 1 час и в due time.
- Предуведомление за 1 час является внутренним и не отображается в пользовательских списках.
- Просмотр списков: все, на сегодня, с фильтрами.
- Удаление напоминаний: по фильтру и последние `N`.
- Удаление по `#ID` (`reminder_id`) и soft-delete (физического удаления нет).
- Плановая отправка напоминаний фоновым планировщиком.
- LLM-only распознавание команд (без локальных «костылей» парсинга).
- Для `list_reminders` используется LLM-уточнение фильтров (диапазон дат/поиск по содержимому), если первичная команда слишком общая.
- При невалидном JSON от LLM выполняется LLM-recovery в строгий формат команды.
- Режим доставки Telegram настраивается через `.env`: `webhook` или `polling`.
- Безопасное удаление: массовое удаление запрещено без явного подтверждения `confirm_delete_all=true`.
- Циклические напоминания привязываются к серии (`series_id`) в таблице `reminder_series`.
- Журнал действий пользователя сохраняется в `reminder_actions` (аудит create/list/delete).

## Технологии

- `Python 3.12`
- `FastAPI` + `aiogram 3`
- `PostgreSQL` + `SQLAlchemy 2` + `Alembic`
- `APScheduler`
- `Pydantic v2`
- `pytest` + `pytest-asyncio`
- `Docker` / `docker compose`

## Архитектурные принципы

- `Schema-first`: LLM отдает JSON, который валидируется Pydantic-схемами.
- Изменения интерпретации фраз делаются через prompt/схемы, а не через разрастание if/else-логики.
- Время хранится в UTC, пользовательская интерпретация времени учитывает `app_timezone`.

## Важные текущие детали

- Диспетчер напоминаний: `app/services/reminder_dispatcher.py`.
- Единый фильтр выборки напоминаний: `SelectionFilter` в `app/services/reminder_service.py`.
- Планировщик запускается в `app/main.py` и периодически отправляет due-напоминания.
- Формат вывода списка в Telegram: `dd.mm.yyyy HH:MM` (без секунд).
- Локализация статусов в списке:
  - `pending` -> `в ожидании`
  - `done` -> `выполнено`

## Запуск локально

```bash
docker compose up -d --build
```

Переключение режима доставки Telegram:

```env
TELEGRAM_DELIVERY_MODE=webhook  # или polling
TELEGRAM_POLLING_DROP_PENDING_UPDATES=true
```

Проверка здоровья:

```bash
curl http://localhost:8000/healthz
```

## Документация

- План проекта: `PROJECT_PLAN.md`
- Локальный чек-лист: `docs/LOCAL_TESTING.md`
- VPS-деплой: `deploy/DEPLOY_VPS.md`
