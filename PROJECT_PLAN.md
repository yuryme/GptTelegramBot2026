# План реализации Telegram AI-ассистента (напоминалка)

## Статус проекта

- [x] Согласованы цель, ограничения и формат работы.
- [x] Выбран подход: поэтапная разработка от простого к сложному.
- [x] Согласован финальный деплой на арендованный VPS.
- [x] Локальная разработка и проверка: работает стабильно.
- [x] Актуальные автотесты: `37 passed`.
- [ ] Фактический VPS-деплой ещё не выполнен.
- [ ] Ротация ранее скомпрометированных секретов должна быть завершена на стороне пользователя.

## Этап 1. Основа проекта (MVP foundation)

- [x] Создать структуру проекта и базовые каталоги.
- [x] Настроить зависимости и конфигурацию окружения (`.env`).
- [x] Поднять Telegram webhook-слой (`FastAPI` + `aiogram`).
- [x] Подключить БД и базовые таблицы напоминаний.
- [x] Добавить миграции БД.
- [x] Добавить Docker Compose для локального запуска.
- [x] Добавить базовые автотесты.

## Этап 2. Базовая LLM-интеграция (schema-first)

- [x] Описать Pydantic-схемы команд LLM.
- [x] Реализовать слой вызова LLM и валидации JSON-команд.
- [x] Ограничить интерпретацию только точным временем.
- [x] Добавить правило времени по умолчанию при указании дня без времени.
- [x] Добавить базовый prompt на русском языке.
- [x] Добавить тесты на валидность и обработку схем.

## Этап 3. Напоминания: создание

- [x] Создание одного напоминания с точной датой/временем.
- [x] Создание нескольких напоминаний одним запросом.
- [x] Поддержка цикличных напоминаний (`recurrence_rule`).
- [x] Отправка подтверждения пользователю в Telegram.
- [x] Тесты сценариев создания.
- [x] Тесты правила времени по умолчанию (день без времени).

## Этап 4. Напоминания: списки и фильтры

- [x] Список всех напоминаний.
- [x] Список напоминаний на сегодня.
- [x] Фильтрация по статусу.
- [x] Поиск по тексту.
- [x] Фильтрация по временному интервалу.
- [x] Тесты сценариев списка и фильтрации.

## Этап 5. Напоминания: удаление

- [x] Удаление по фильтру.
- [x] Удаление по ограничению количества (последние `N`).
- [x] Подтверждение удалений пользователю.
- [x] Тесты сценариев удаления.

## Этап 6. Надежность и эксплуатация

- [x] Логи и базовая обработка ошибок.
- [x] Защита от дублей webhook-событий.
- [x] Контроль лимита затрат на модели (до `$10/мес`).
- [x] Ретраи для временных сетевых ошибок LLM.
- [x] Fail-fast на `429` (лимит/квота OpenAI).
- [x] Per-chat rate limit.
- [x] Circuit breaker при серии `429`.
- [x] Alert-пороги бюджета (`50%`/`80%`/`100%`).
- [x] Фильтр устаревших pending updates.
- [x] Тесты для dedup/cost/guardrails.

## Этап 7. Подготовка к VPS-деплою

- [x] Production compose (`deploy/docker-compose.prod.yml`).
- [x] Шаблон production-переменных (`deploy/.env.prod.example`).
- [x] Конфиг `nginx` для webhook.
- [x] Настройка `systemd` + `docker compose`.
- [x] HTTPS через Let's Encrypt.
- [x] Инструкция по деплою на VPS (`deploy/DEPLOY_VPS.md`).
- [ ] Фактический деплой на VPS.
- [ ] Smoke-проверка после деплоя на VPS.

## Этап 8. Локальное интеграционное тестирование перед VPS

- [x] Скрипт локального прогона (`scripts/local_integration_check.ps1`).
- [x] Чек-лист ручного smoke (`docs/LOCAL_TESTING.md`).
- [x] Исправить миграцию enum (устранить `DuplicateObject`).
- [x] Добавить раннее завершение скрипта при ошибках шагов.
- [x] Добавить ретраи healthcheck + вывод логов контейнера при сбое.
- [x] Добавить установку dev-зависимостей в контейнере перед `pytest`.
- [x] Исправить запуск API при невалидном Telegram-токене (healthcheck не падает).
- [x] Подтверждено текущее локальное состояние: `28 passed`.

## Этап 9. Локальный webhook и операционные фиксы

- [x] Настроить локальный webhook через ngrok с путем `/webhook/telegram`.
- [x] Подтвердить обработку webhook (`POST /webhook/telegram 200`).
- [x] Устранить каскадные запросы к OpenAI при `429`.
- [ ] Ротация скомпрометированных секретов (Telegram token / OpenAI key / webhook secret).

## Этап 10. Планировщик и точность времени

- [x] Реализовать фонового диспетчера отправки напоминаний (`APScheduler` + `reminder_dispatcher`).
- [x] Добавить обработку цикличности (`FREQ=DAILY|WEEKLY|MONTHLY`, `INTERVAL`).
- [x] Нормализовать хранение времени в UTC и корректно учитывать `app_timezone`.
- [x] Уточнить prompt/схемы для человеческих форм времени (включая формат `10-30`).
- [x] Улучшить формат ответов списка: читаемый вывод без секунд (`dd.mm.yyyy HH:MM`).
- [x] Локализовать статусы списка: `pending -> в ожидании`, `done -> выполнено`.
- [x] Для напоминаний с датой начиная с завтра создавать 2 события: за 1 час и в due time.
- [x] Скрыть внутреннее предуведомление за 1 час из пользовательских списков.
- [x] Добавить/обновить тесты (`test_reminder_dispatcher.py`, `test_prompt_rules.py`, расширения `test_llm_schema.py`).

## Этап 11. LLM-уточнение фильтров списков

- [x] Перевести обработку естественных формулировок дат/диапазонов в списках на LLM-уточнение команды.
- [x] Убрать regex-эвристики по пользовательскому тексту из Python-слоя для фильтров списка.
- [x] Добавить LLM-recovery для невалидного JSON ответа модели.
- [x] Добавить LLM-нормализацию `search_text` для более устойчивого поиска по содержимому.
- [x] Добавить/обновить тесты (`tests/test_llm_search_filter.py`, `tests/test_llm_recovery.py`).

## Этап 12. Режимы доставки Telegram (webhook/polling)

- [x] Добавить конфигурацию режима доставки в настройки (`TELEGRAM_DELIVERY_MODE`).
- [x] Добавить запуск `aiogram` в режиме polling через lifespan FastAPI.
- [x] В режиме polling отключать webhook и при необходимости сбрасывать pending updates.
- [x] Ограничить webhook endpoint режимом `webhook` (в polling возвращать `409`).
- [x] Обновить env-шаблоны (`.env.example`, `deploy/.env.prod.example`).

## Этап 13. Безопасное удаление напоминаний

- [x] Запретить неявное массовое удаление `delete_reminders` без фильтра.
- [x] Добавить явное подтверждение массового удаления: `confirm_delete_all=true`.
- [x] Добавить совместимость с legacy-ключом LLM `filter_status -> status`.
- [x] Обновить prompt и тесты под удаление по статусу (`done/pending/canceled`).

## Принципы выполнения

- [x] Русский язык во всем пользовательском взаимодействии.
- [x] UTF-8 для всех файлов проекта.
- [x] Изменения поведения через prompt/схемы, а не через hardcode бизнес-логики.
- [x] Каждое существенное изменение сопровождается обновлением документации и тестами.
- [x] План проекта обновляется при добавлении/изменении/исключении пунктов.
- [x] После одобрения пользователя обязательно обновляются `README.md` и `PROJECT_PLAN.md`, затем выполняются `git commit` и `git push`.
